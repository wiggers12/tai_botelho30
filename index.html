<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Espaço Tai Botelho - Sistema Completo</title>

<link rel="manifest" href="data:application/manifest+json;base64,eyJpY29ucyI6W3sic2l6ZXMiOiIxOTJ4MTkyIiwic3JjIjoiaWNvbnMvaWNvbi0xOTJ4MTkyLnBuZyIsInR5cGUiOiJpbWFnZS9wbmcifV0sIm5hbWUiOiJFc3Bhw6dvIFRaiSBCb3RlbGhvIiwic2hvcnRfbmFtZSI6IlRaiSBCb3RlbGhvIiwiZGVzY3JpcHRpb24iOiJTaXN0ZW1hIGRlIEplc3TDo28gcGFyYSBFc3Bhw6dvIFRaiSBCb3RlbGhvIiwic3RhcnRfdXJsIjoiLi9pbmRleC5odG1sIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiI2Y4YmJkMCIsInRoZW1lX2NvbG9yIjoiIzdiMWZhMiIsIm9yaWVudGF0aW9uIjoicG9ydHJhaXQifQ=">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
/* Reset & base */
* {
  box-sizing: border-box;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}
body {
  margin: 0;
  background: linear-gradient(135deg, #fce4ec, #f8bbd0);
  color: #4a2c4d;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  overflow-y: auto; /* Permite rolagem no body se o conteúdo total exceder 100vh */
}

/* Splash Screen / Login Screen */
#splash, #loginScreen {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  background: linear-gradient(135deg, #ce93d8, #ba68c8);
  color: white;
  transition: opacity 0.6s ease;
  padding: 20px;
}
#splash h1, #loginScreen h1 {
  font-size: 3rem;
  margin-bottom: 20px;
  text-shadow: 1px 1px 4px #6d3c77;
}
#loginScreen {
    display: none; /* Inicia oculto, será mostrado após splash */
}
#loginForm {
    background: rgba(255, 255, 255, 0.9);
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    text-align: center;
    color: #4a2c4d;
    max-width: 400px;
    width: 90%;
}
#loginForm label {
    display: block;
    margin-bottom: 8px;
    font-weight: bold;
    text-align: left;
}
#loginForm input[type="password"] {
    width: calc(100% - 20px);
    padding: 10px;
    margin-bottom: 20px;
    border: 1px solid #ce93d8;
    border-radius: 8px;
    font-size: 1.1rem;
}
#loginForm button {
    background: #7b1fa2;
    border: none;
    padding: 12px 30px;
    font-size: 1.2rem;
    border-radius: 25px;
    color: white;
    cursor: pointer;
    box-shadow: 0 4px 10px #4a0072;
    transition: background-color 0.3s ease;
}
#loginForm button:hover {
    background: #9c27b0;
}
#loginError {
    color: #e53935;
    margin-top: 10px;
    font-weight: bold;
    display: none;
}

#btnEntrar {
  background: #7b1fa2;
  border: none;
  padding: 15px 40px;
  font-size: 1.25rem;
  border-radius: 30px;
  color: white;
  cursor: pointer;
  box-shadow: 0 6px 15px #4a0072;
  transition: background-color 0.3s ease;
}
#btnEntrar:hover {
  background: #9c27b0;
}

/* Main container */
#main {
  display: none;
  flex: 1; /* Permite que o main ocupe o espaço restante quando visível */
  padding: 20px;
  max-width: 1200px;
  margin: 0 auto;
  width: 100%;
}

/* Menu */
.menu {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 16px;
  margin-bottom: 30px;
}
.menu-item {
  background: white;
  border-radius: 18px;
  box-shadow: 0 5px 15px rgb(160 75 149 / 0.3);
  cursor: pointer;
  flex: 1 1 130px;
  max-width: 150px;
  padding: 20px 10px;
  text-align: center;
  color: #7b1fa2;
  user-select: none;
  transition: transform 0.2s ease, box-shadow 0.3s ease;
}
.menu-item:hover {
  box-shadow: 0 8px 20px rgb(160 75 149 / 0.6);
  transform: translateY(-5px);
}
.menu-item span {
  font-size: 2.7rem;
  display: block;
  margin-bottom: 10px;
}
.menu-item p {
  font-weight: 700;
  font-size: 1.1rem;
  margin: 0;
}

/* Sections */
section {
  background: rgba(255 255 255 / 0.95);
  border-radius: 16px;
  padding: 25px;
  box-shadow: 0 6px 18px rgb(160 75 149 / 0.25);
  max-width: 100%;
  margin-bottom: 30px;
  /* NOVO: Propriedades para organizar o conteúdo da seção */
  display: flex;
  flex-direction: column;
  gap: 20px; /* Espaçamento entre os elementos internos da seção */
}

section h3 {
  margin-top: 0;
  color: #4a2c4d;
  margin-bottom: 15px;
  border-bottom: 2px solid #ce93d8;
  padding-bottom: 6px;
}

/* Forms */
.form-group {
  margin-bottom: 12px;
}
label {
  display: block;
  margin-bottom: 5px;
  font-weight: 600;
}
input, select, textarea {
  width: 100%;
  padding: 10px 12px;
  border-radius: 10px;
  border: 1.8px solid #ce93d8;
  font-size: 1rem;
  transition: border-color 0.3s ease;
}
input:focus, select:focus, textarea:focus {
  border-color: #7b1fa2;
  outline: none;
}
textarea {
  resize: vertical;
  min-height: 60px;
}
button {
  background: #7b1fa2;
  border: none;
  padding: 12px 28px;
  border-radius: 30px;
  color: white;
  font-weight: 700;
  cursor: pointer;
  font-size: 1rem;
  transition: background-color 0.3s ease;
  margin-top: 10px;
  margin-right: 8px; /* Espaçamento entre botões */
}
button:hover {
  background: #9c27b0;
}

/* Validação de formulário */
input.error, select.error, textarea.error {
  border-color: #e53935;
  background-color: #ffebee;
}
.error-message {
  color: #e53935;
  font-size: 0.85rem;
  margin-top: 4px;
  display: block;
}

/* Busca */
.busca input {
  padding: 10px 12px;
  border-radius: 20px;
  border: 1.8px solid #ce93d8;
  width: 100%;
  font-size: 1rem;
  margin-bottom: 20px;
}

/* Listas */
.item {
  background: #f3e5f5;
  margin-bottom: 12px;
  border-radius: 14px;
  padding: 14px 18px;
  box-shadow: 0 2px 6px rgb(160 75 149 / 0.15);
}
.item strong {
  font-size: 1.1rem;
  color: #6a1b9a;
}
.item small {
  display: block;
  margin-top: 4px;
  color: #7b1fa2cc;
}
.item button {
  margin-left: 0;
  margin-top: 8px;
  border-radius: 20px;
  padding: 5px 12px;
  font-size: 0.9rem;
  box-shadow: none;
}
.item button.editar {
  background: #9c27b0;
  color: white;
}
.item button.excluir {
  background: #e53935;
  color: white;
}
.item button.info {
  background: #03a9f4;
  color: white;
}
.item .status-concluido {
    color: #2e7d32; /* Verde escuro */
    font-weight: bold;
}
.item .status-pendente {
    color: #ef6c00; /* Laranja */
    font-weight: bold;
}
.item .status-nao-pagou {
    color: #e53935; /* Vermelho */
    font-weight: bold;
}


.flex-row {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  align-items: center;
}
.flex-row > * {
  flex: 1 1 150px;
}
.flex-col {
    display: flex;
    flex-direction: column;
    gap: 10px;
}

/* Responsive */
@media(max-width: 768px){
  .menu {
    justify-content: center;
  }
  .menu-item {
    max-width: 120px;
    font-size: 0.9rem;
    padding: 18px 8px;
  }
  .menu-item span {
    font-size: 2rem;
  }
  button {
    width: auto;
    display: inline-block;
  }
  .item button {
      width: 100%;
      margin-right: 0;
  }
}

/* Export/Import Buttons */
#backupSection {
  margin-top: 15px;
  text-align: center;
}
#backupSection button {
  margin: 5px;
  min-width: 120px;
}

/* Toast Notification */
.toast {
    visibility: hidden;
    min-width: 250px;
    margin-left: -125px;
    background-color: #333;
    color: #fff;
    text-align: center;
    border-radius: 8px;
    padding: 16px;
    position: fixed;
    z-index: 1000;
    left: 50%;
    bottom: 30px;
    font-size: 17px;
    opacity: 0;
    transition: opacity 0.5s, visibility 0.5s;
}
.toast.show {
    visibility: visible;
    opacity: 1;
}

/* Custom Modal */
.modal-overlay {
    display: none;
    position: fixed;
    z-index: 999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgba(0,0,0,0.4);
    justify-content: center;
    align-items: center;
}
.modal-content {
    background-color: #fefefe;
    margin: auto;
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.2);
    width: 90%;
    max-width: 400px;
    text-align: center;
    color: #4a2c4d;
}
.modal-content h4 {
    margin-top: 0;
    color: #6a1b9a;
}
.modal-content p {
    margin-bottom: 25px;
}
.modal-buttons button {
    margin: 5px;
    padding: 10px 20px;
    border-radius: 20px;
    font-weight: 600;
    cursor: pointer;
}
.modal-buttons .confirm-btn {
    background-color: #e53935;
    color: white;
}
.modal-buttons .cancel-btn {
    background-color: #ccc;
    color: #4a2c4d;
}

/* Specific Modal for Payment */
#paymentModal .modal-content {
    max-width: 500px;
}
#paymentModal .form-group {
    text-align: left;
}
#paymentModal button {
    margin-top: 15px;
}


/* Dashboard Specific Styles */
.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    /* Removido margin-top, pois a section agora tem gap */
}

.dashboard-card {
    background-color: #fff;
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    text-align: center;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

.dashboard-card.card-clientes { background: linear-gradient(45deg, #e0f2f7, #bbdefb); color: #1565c0; }
.dashboard-card.card-profissionais { background: linear-gradient(45deg, #e8f5e9, #c8e6c9); color: #2e7d32; }
.dashboard-card.card-produtos { background: linear-gradient(45deg, #fff3e0, #ffe0b2); color: #ef6c00; }
.dashboard-card.card-agendamentos { background: linear-gradient(45deg, #fbe9e7, #ffccbc); color: #d84315; }
.dashboard-card.card-caixa { background: linear-gradient(45deg, #f3e5f5, #e1bee7); color: #6a1b9a; }
.dashboard-card.card-lucro { background: linear-gradient(45deg, #e0f7fa, #b2ebf2); color: #00838f; }
.dashboard-card.card-alert { background: linear-gradient(45deg, #ffecb3, #ffe082); color: #ffa000; }

.dashboard-card .card-value {
    font-size: 2.5rem;
    font-weight: bold;
    margin-top: 10px;
    margin-bottom: 5px;
}

.dashboard-card .card-title {
    font-size: 1.1rem;
    color: rgba(0,0,0,0.7);
    margin-bottom: 0;
}
.dashboard-card a {
    color: inherit;
    text-decoration: none;
    font-weight: bold;
    margin-top: 10px;
}
.dashboard-card a:hover {
    text-decoration: underline;
}

.dashboard-chart-container {
    background: white;
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 6px 18px rgb(160 75 149 / 0.25);
    /* Removido margin-top, pois a section agora tem gap */
    height: 400px; /* Altura fixa para o contêiner do gráfico */
    display: flex;
    flex-direction: column;
}

/* Garante que o canvas do gráfico se ajuste ao seu contêiner */
.dashboard-chart-container canvas {
    flex: 1; /* Permite que o canvas cresça para preencher o espaço disponível no contêiner flex */
    max-height: 100%; /* Garante que o canvas não transborde */
}

.chart-filter-controls {
    display: flex;
    gap: 10px;
    margin-bottom: 15px;
    align-items: center;
    flex-wrap: wrap;
}
.chart-filter-controls label {
    margin-bottom: 0;
    font-weight: normal;
}
.chart-filter-controls select, .chart-filter-controls input[type="date"], .chart-filter-controls input[type="month"] {
    width: auto;
    flex-grow: 1;
    max-width: 180px;
    padding: 8px 12px;
    border-radius: 8px;
}
.chart-filter-controls button {
    margin-top: 0;
    padding: 8px 15px;
    border-radius: 20px;
    font-size: 0.9rem;
}

.dashboard-agendamentos-proximos {
    background: #fff;
    border-radius: 16px;
    padding: 20px;
    box-shadow: 0 6px 18px rgba(160, 75, 149, 0.25);
    /* Removido margin-top, pois a section agora tem gap */
}
.dashboard-agendamentos-proximos ul {
    list-style: none;
    padding: 0;
    max-height: 200px; /* Altura máxima com rolagem para a lista de agendamentos */
    overflow-y: auto;
}
.dashboard-agendamentos-proximos li {
    background-color: #f3e5f5;
    margin-bottom: 8px;
    padding: 10px 15px;
    border-radius: 8px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.95rem;
    flex-wrap: wrap; /* Para quebra de linha em telas menores */
}
.dashboard-agendamentos-proximos li strong {
    color: #6a1b9a;
}
.dashboard-agendamentos-proximos li span {
    font-size: 0.85rem;
    color: #7b1fa2;
}

/* Estilos para rolagem interna de listas longas nas seções */
#listaClientes, #listaProfissionais, #listaProdutos, #produtosEmFalta,
#listaGanhos, #listaGastos, #historicoMovimentacoes {
    max-height: 300px; /* Altura máxima para listas de itens genéricas */
    overflow-y: auto;
    padding-right: 10px; /* Adiciona padding para evitar que o conteúdo encoste na barra de rolagem */
}
/* A lista de agendamentos agora está em #listaTodosAgendamentos */
#listaAgendamentos, #listaTodosAgendamentos {
    max-height: 400px; /* Um pouco mais alta para a lista de agendamentos */
    overflow-y: auto;
    padding-right: 10px;
}


</style>
</head>
<body>

<div id="splash">
  <h1>Espaço Tai Botelho</h1>
  <button id="btnEntrar">Entrar</button>
</div>

<div id="loginScreen">
  <h1>Acesso Restrito</h1>
  <div id="loginForm">
    <label for="password">Senha:</label>
    <input type="password" id="password" placeholder="Digite a senha" />
    <span id="loginError" class="error-message"></span>
    <button id="btnLogin">Acessar Sistema</button>
  </div>
</div>

<div id="main">
  <div class="menu">
    <div class="menu-item" onclick="abrirSecao('dashboardSection')"><span>📊</span><p>Dashboard</p></div>
    <div class="menu-item" onclick="abrirSecao('clientesSection')"><span>👥</span><p>Clientes</p></div>
    <div class="menu-item" onclick="abrirSecao('profissionaisSection')"><span>💇‍♀️</span><p>Profissionais</p></div>
    <div class="menu-item" onclick="abrirSecao('produtosSection')"><span>🧴</span><p>Produtos</p></div>
    <div class="menu-item" onclick="abrirSecao('agendamentosSection')"><span>➕📅</span><p>Agendar</p></div>
    <div class="menu-item" onclick="abrirSecao('agendadosSection')"><span>✅📅</span><p>Agendados</p></div>
    <div class="menu-item" onclick="abrirSecao('financeiroSection')"><span>💰</span><p>Financeiro</p></div>
    <div class="menu-item" onclick="abrirSecao('backupSection')"><span>💾</span><p>Backup</p></div>
  </div>

  <section id="dashboardSection" style="display:none;">
    <h3>Dashboard Principal</h3>

    <div class="dashboard-grid">
        <div class="dashboard-card card-clientes">
            <p class="card-title">Total de Clientes</p>
            <p class="card-value" id="dashTotalClientes">0</p>
        </div>
        <div class="dashboard-card card-profissionais">
            <p class="card-title">Total de Profissionais</p>
            <p class="card-value" id="dashTotalProfissionais">0</p>
        </div>
        <div class="dashboard-card card-produtos">
            <p class="card-title">Produtos em Estoque</p>
            <p class="card-value" id="dashTotalProdutos">0</p>
        </div>
        <div class="dashboard-card card-agendamentos">
            <p class="card-title">Agendamentos Pendentes</p>
            <p class="card-value" id="dashTotalAgendamentos">0</p>
        </div>
        <div class="dashboard-card card-caixa">
            <p class="card-title">Caixa Atual</p>
            <p class="card-value" id="dashCaixaAtual">R$ 0,00</p>
        </div>
        <div class="dashboard-card card-lucro">
            <p class="card-title">Lucro Mensal (Mês Atual)</p>
            <p class="card-value" id="dashLucroMensal">R$ 0,00</p>
        </div>
        <div class="dashboard-card card-caixa">
            <p class="card-title">Ganhos Mensais (Mês Atual)</p>
            <p class="card-value" id="dashGanhosMensal">R$ 0,00</p>
        </div>
        <div class="dashboard-card card-agendamentos">
            <p class="card-title">Gastos Mensais (Mês Atual)</p>
            <p class="card-value" id="dashGastosMensal">R$ 0,00</p>
        </div>
        <div class="dashboard-card card-alert" id="dashAlertProdutosEmFalta" style="display:none;">
            <p class="card-title">Produtos em Falta</p>
            <p class="card-value" id="dashQtdProdutosEmFalta">0</p>
            <a href="#" onclick="abrirSecao('produtosSection'); return false;">Ver Estoque</a>
        </div>
    </div>

    <div class="dashboard-chart-container">
        <h4>Ganhos x Gastos x Lucro por Período</h4>
        <div class="chart-filter-controls">
            <label for="filtroMesFinanceiro">Mês/Ano:</label>
            <input type="month" id="filtroMesFinanceiro" onchange="desenharGraficoFinanceiro()">
            <label for="filtroAnoFinanceiro">Ano:</label>
            <select id="filtroAnoFinanceiro" onchange="desenharGraficoFinanceiro()"></select>
            <button onclick="desenharGraficoFinanceiro()">Atualizar</button>
            <button onclick="resetFiltroFinanceiro()">Limpar Filtro</button>
        </div>
        <canvas id="graficoFinanceiro"></canvas>
    </div>

    <div class="dashboard-chart-container">
        <h4>Agendamentos por Profissional</h4>
        <canvas id="graficoAgendamentosProfissional"></canvas>
    </div>

    <div class="dashboard-chart-container">
        <h4>Top 5 Serviços Mais Realizados (por valor)</h4>
        <canvas id="graficoServicosPopulares"></canvas>
    </div>

    <div class="dashboard-chart-container">
        <h4>Novos Clientes por Mês</h4>
        <canvas id="graficoNovosClientes"></canvas>
    </div>

    <div class="dashboard-agendamentos-proximos">
        <h4>Próximos Agendamentos (7 dias)</h4>
        <ul id="listaAgendamentosProximos">
            <li>Nenhum agendamento próximo.</li>
        </ul>
    </div>
  </section>

  <section id="clientesSection" style="display:none;">
    <h3>Cadastro de Clientes</h3>
    <div class="form-group">
      <label for="nomeCliente">Nome:</label>
      <input type="text" id="nomeCliente" onblur="validateField('nomeCliente', 'errorNomeCliente', 'Nome do cliente é obrigatório.')" />
      <span class="error-message" id="errorNomeCliente"></span>
    </div>
    <div class="form-group">
      <label for="telefoneCliente">Telefone:</label>
      <input type="text" id="telefoneCliente" placeholder="(XX) XXXXX-XXXX" />
      <span class="error-message" id="errorTelefoneCliente"></span>
    </div>
    <div class="form-group">
      <label for="emailCliente">Email:</label>
      <input type="email" id="emailCliente" onblur="validateEmail('emailCliente', 'errorEmailCliente', 'Email inválido.')"/>
      <span class="error-message" id="errorEmailCliente"></span>
    </div>
    <div class="form-group">
      <label for="dataCadastroCliente">Data de Cadastro:</label>
      <input type="date" id="dataCadastroCliente" />
    </div>
    <div class="form-group">
      <label for="obsCliente">Observações:</label>
      <textarea id="obsCliente"></textarea>
    </div>
    <button onclick="salvarCliente()">Salvar Cliente</button>
    <button onclick="limparCamposCliente()">Novo/Limpar</button>

    <div class="busca">
      <input type="text" id="buscaCliente" placeholder="Buscar cliente..." oninput="listarClientes()" />
    </div>
    <div id="listaClientes"></div>
  </section>

  <section id="profissionaisSection" style="display:none;">
    <h3>Cadastro de Profissionais</h3>
    <div class="form-group">
      <label for="nomeProf">Nome:</label>
      <input type="text" id="nomeProf" onblur="validateField('nomeProf', 'errorNomeProf', 'Nome do profissional é obrigatório.')"/>
      <span class="error-message" id="errorNomeProf"></span>
    </div>
    <div class="form-group">
      <label for="espProf">Especialidade:</label>
      <input type="text" id="espProf" onblur="validateField('espProf', 'errorEspProf', 'Especialidade é obrigatória.')"/>
      <span class="error-message" id="errorEspProf"></span>
    </div>
    <div class="form-group">
      <label for="servicoProf">Serviço Principal:</label>
      <input type="text" id="servicoProf" onblur="validateField('servicoProf', 'errorServicoProf', 'Serviço é obrigatório.')"/>
      <span class="error-message" id="errorServicoProf"></span>
    </div>
    <div class="form-group">
      <label for="valorProf">Valor (R$):</label>
      <input type="number" id="valorProf" min="0" step="0.01" onblur="validateNumber('valorProf', 'errorValorProf', 'Valor do serviço é obrigatório e deve ser positivo.')"/>
      <span class="error-message" id="errorValorProf"></span>
    </div>
    <button onclick="salvarProfissional()">Salvar Profissional</button>
    <button onclick="limparCamposProfissional()">Novo/Limpar</button>

    <div class="busca">
      <input type="text" id="buscaProfissional" placeholder="Buscar profissional..." oninput="listarProfissionais()" />
    </div>
    <div id="listaProfissionais"></div>
  </section>

  <section id="produtosSection" style="display:none;">
    <h3>Cadastro de Produtos</h3>
    <div class="form-group">
      <label for="nomeProduto">Nome do Produto:</label>
      <input type="text" id="nomeProduto" onblur="validateField('nomeProduto', 'errorNomeProduto', 'Nome do produto é obrigatório.')"/>
      <span class="error-message" id="errorNomeProduto"></span>
    </div>
    <div class="form-group">
      <label for="tipoProduto">Tipo do Produto:</label>
      <input type="text" id="tipoProduto" onblur="validateField('tipoProduto', 'errorTipoProduto', 'Tipo do produto é obrigatório.')"/>
      <span class="error-message" id="errorTipoProduto"></span>
    </div>
    <div class="form-group">
      <label for="quantidadeProduto">Quantidade em Estoque:</label>
      <input type="number" id="quantidadeProduto" min="0" onblur="validateNumber('quantidadeProduto', 'errorQuantidadeProduto', 'Quantidade é obrigatória e deve ser positiva.')"/>
      <span class="error-message" id="errorQuantidadeProduto"></span>
    </div>
    <div class="form-group">
      <label for="minQuantidadeProduto">Quantidade Mínima para Alerta:</label>
      <input type="number" id="minQuantidadeProduto" min="0" onblur="validateNumber('minQuantidadeProduto', 'errorMinQuantidadeProduto', 'Quantidade mínima é obrigatória e deve ser positiva.')"/>
      <span class="error-message" id="errorMinQuantidadeProduto"></span>
    </div>
    <div class="form-group">
      <label for="validadeProduto">Data de Validade (opcional):</label>
      <input type="date" id="validadeProduto" />
    </div>
    <button onclick="salvarProduto()">Salvar Produto</button>
    <button onclick="limparCamposProduto()">Novo/Limpar</button>

    <div class="busca">
      <input type="text" id="buscaProduto" placeholder="Buscar produto..." oninput="listarProdutos()" />
    </div>
    <div id="listaProdutos"></div>

    <h4>Produtos em falta</h4>
    <div id="produtosEmFalta"></div>

    <h4>Usar Produto</h4>
    <div class="flex-row" style="gap: 10px; flex-wrap: nowrap; margin-bottom: 10px;">
      <select id="selectProdutoUso" style="flex-grow:1;"></select>
      <input type="number" id="quantidadeUso" min="1" placeholder="Quantidade" style="max-width: 100px;" />
      <button onclick="usarProduto()">Usar Produto</button>
    </div>

    <h4>Histórico de Movimentações</h4>
    <div id="historicoMovimentacoes"></div>
  </section>

  <section id="agendamentosSection" style="display:none;">
    <h3>Novo Agendamento</h3>
    <div class="form-group">
      <label for="selectClienteAgendamento">Cliente:</label>
      <select id="selectClienteAgendamento" onblur="validateSelect('selectClienteAgendamento', 'errorSelectClienteAgendamento', 'Selecione um cliente.')"></select>
      <span class="error-message" id="errorSelectClienteAgendamento"></span>
    </div>
    <div class="form-group">
      <label for="selectProfissionalAgendamento">Profissional:</label>
      <select id="selectProfissionalAgendamento" onchange="atualizarServicosProfissional(); validateSelect('selectProfissionalAgendamento', 'errorSelectProfissionalAgendamento', 'Selecione um profissional.');"></select>
      <span class="error-message" id="errorSelectProfissionalAgendamento"></span>
    </div>
    <div class="form-group">
      <label for="selectServicoAgendamento">Serviço:</label>
      <select id="selectServicoAgendamento" onblur="validateSelect('selectServicoAgendamento', 'errorSelectServicoAgendamento', 'Selecione um serviço.')"></select>
      <span class="error-message" id="errorSelectServicoAgendamento"></span>
    </div>
    <div class="form-group">
      <label for="dataAgendamento">Data:</label>
      <input type="date" id="dataAgendamento" onblur="validateField('dataAgendamento', 'errorDataAgendamento', 'Data é obrigatória.')"/>
      <span class="error-message" id="errorDataAgendamento"></span>
    </div>
    <div class="form-group">
      <label for="horaAgendamento">Hora:</label>
      <input type="time" id="horaAgendamento" onblur="validateField('horaAgendamento', 'errorHoraAgendamento', 'Hora é obrigatória.')"/>
      <span class="error-message" id="errorHoraAgendamento"></span>
    </div>
    <button onclick="salvarAgendamento()">Salvar Agendamento</button>
    <input type="hidden" id="agendamentoEditandoId" />
  </section>

  <section id="agendadosSection" style="display:none;">
    <h3>Clientes Agendados (Futuros e Histórico)</h3>
    <div class="busca" style="margin-top:0;">
      <input type="text" id="buscaTodosAgendamentos" placeholder="Buscar por nome do cliente..." oninput="listarTodosAgendamentos()" />
    </div>
    <div class="flex-row" style="gap:10px; margin: 10px 0;">
      <label>
        <input type="checkbox" id="filtroAgendadosPendentes" checked onchange="listarTodosAgendamentos()" />
        Mostrar apenas pendentes/futuros
      </label>
      <label style="flex-grow:1;">
        Filtrar por data:
        <input type="date" id="filtroAgendadosData" onchange="listarTodosAgendamentos()" />
      </label>
      <button onclick="limparFiltrosTodosAgendamentos()">Limpar filtros</button>
    </div>
    <div id="listaTodosAgendamentos"></div>
  </section>

<section id="financeiroSection" style="display:none;">
    <h3>Financeiro</h3>

    <div class="form-group">
      <label for="caixaInicial">Caixa Inicial (R$):</label>
      <input type="number" id="caixaInicial" min="0" step="0.01" onblur="validateNumber('caixaInicial', 'errorCaixaInicial', 'Valor do caixa inicial deve ser positivo.')" />
      <span class="error-message" id="errorCaixaInicial"></span>
      <button onclick="salvarCaixaInicial()">Salvar Caixa Inicial</button>
    </div>

    <h4>Ganhos (Agendamentos realizados)</h4>
    <div id="listaGanhos" style="max-height: 150px; overflow-y: auto; background: #fce4ec; padding: 10px; border-radius: 12px;"></div>

    <h4>Gastos</h4>
    <div class="form-group">
      <label for="descricaoGasto">Descrição:</label>
      <input type="text" id="descricaoGasto" onblur="validateField('descricaoGasto', 'errorDescricaoGasto', 'Descrição do gasto é obrigatória.')"/>
      <span class="error-message" id="errorDescricaoGasto"></span>
    </div>
    <div class="form-group">
      <label for="valorGasto">Valor (R$):</label>
      <input type="number" id="valorGasto" min="0" step="0.01" onblur="validateNumber('valorGasto', 'errorValorGasto', 'Valor do gasto é obrigatório e deve ser positivo.')"/>
      <span class="error-message" id="errorValorGasto"></span>
    </div>
    <div class="form-group">
      <label for="dataGasto">Data:</label>
      <input type="date" id="dataGasto" onblur="validateField('dataGasto', 'errorDataGasto', 'Data do gasto é obrigatória.')"/>
      <span class="error-message" id="errorDataGasto"></span>
    </div>
    <button onclick="salvarGasto()">Salvar Gasto</button>

    <h4>Lista de Gastos</h4>
    <div id="listaGastos" style="max-height: 150px; overflow-y: auto; background: #fce4ec; padding: 10px; border-radius: 12px;"></div>

    <h4>Resumo Financeiro Mensal</h4>
    <p><strong>Caixa Atual:</strong> <span id="caixaAtual">R$ 0,00</span></p>
    <p><strong>Ganhos Totais:</strong> <span id="ganhosTotais">R$ 0,00</span></p>
    <p><strong>Gastos Totais:</strong> <span id="gastosTotais">R$ 0,00</span></p>
    <p><strong>Lucro Total:</strong> <span id="lucroTotal">R$ 0,00</span></p>
  </section>

  <section id="backupSection" style="display:none;">
    <h3>Backup e Restauração de Dados</h3>
    <button onclick="exportarDados()">Exportar Dados (Backup)</button>
    <button onclick="triggerImport()">Importar Dados</button>
    <input type="file" id="inputImport" accept="application/json" style="display:none" onchange="confirmImport(event)" />
  </section>
</div>

<div id="toastNotification" class="toast"></div>

<div id="confirmationModal" class="modal-overlay">
    <div class="modal-content">
        <h4 id="modalTitle">Confirmação</h4>
        <p id="modalMessage"></p>
        <div class="modal-buttons">
            <button class="confirm-btn" id="modalConfirmBtn">Sim</button>
            <button class="cancel-btn" id="modalCancelBtn">Não</button>
        </div>
    </div>
</div>

<div id="paymentModal" class="modal-overlay">
    <div class="modal-content">
        <h4>Registrar Pagamento</h4>
        <p>Informe os detalhes do pagamento para o agendamento:</p>
        <div class="form-group">
            <label for="paymentMethod">Forma de Pagamento:</label>
            <select id="paymentMethod">
                <option value="">-- Selecione --</option>
                <option value="Dinheiro">Dinheiro</option>
                <option value="Pix">Pix</option>
                <option value="Debito">Débito</option>
                <option value="Credito">Crédito</option>
            </select>
            <span class="error-message" id="errorPaymentMethod"></span>
        </div>
        <label>
            <input type="checkbox" id="clientDidNotPay"> Cliente não pagou
        </label>
        <div class="modal-buttons">
            <button class="confirm-btn" id="confirmPaymentBtn">Confirmar</button>
            <button class="cancel-btn" id="cancelPaymentBtn">Cancelar</button>
        </div>
    </div>
</div>


<script>
// Variáveis globais para os dados (simulando um banco de dados local)
let clientes = JSON.parse(localStorage.getItem("clientes")) || [];
let profissionais = JSON.parse(localStorage.getItem("profissionais")) || [];
let produtos = JSON.parse(localStorage.getItem("produtos")) || [];
let agendamentos = JSON.parse(localStorage.getItem("agendamentos")) || [];
let gastos = JSON.parse(localStorage.getItem("gastos")) || [];
let caixaInicial = parseFloat(localStorage.getItem("caixaInicial")) || 0;

// Variáveis de controle de edição
let clienteEditandoId = null;
let profissionalEditandoId = null;
let produtoEditandoId = null;

// Variáveis para o modal de pagamento
let currentAgendamentoIdForPayment = null;

// Constante para a senha de acesso (pode ser alterada)
const MASTER_PASSWORD = "admin"; // Senha simples para controle de acesso básico

// Objeto para formatar moeda
const currencyFormatter = new Intl.NumberFormat('pt-BR', {
  style: 'currency',
  currency: 'BRL',
});

// Cores para os gráficos
const chartColors = {
    primary: '#7b1fa2', // Roxo principal
    secondary: '#ce93d8', // Roxo claro
    success: '#4caf50', // Verde
    warning: '#ffc107', // Amarelo
    danger: '#e53935', // Vermelho
    info: '#03a9f4', // Azul claro
    dark: '#4a2c4d', // Roxo escuro
    light: '#f3e5f5' // Roxo muito claro
};

// ============ UTILITÁRIOS GERAIS ============

// Função para exibir notificações Toast
function showToast(message, duration = 3000) {
    const toast = document.getElementById("toastNotification");
    toast.textContent = message;
    toast.classList.add("show");
    setTimeout(() => {
        toast.classList.remove("show");
    }, duration);
}

// Função para gerar IDs únicos (UUID simples)
function generateUUID() {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    const r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}

// ============ VALIDAÇÕES DE FORMULÁRIO ============

function validateField(fieldId, errorId, message) {
    const field = document.getElementById(fieldId);
    const errorSpan = document.getElementById(errorId);
    if (field.value.trim() === '') {
        field.classList.add('error');
        errorSpan.textContent = message;
        return false;
    }
    field.classList.remove('error');
    errorSpan.textContent = '';
    return true;
}

function validateNumber(fieldId, errorId, message) {
    const field = document.getElementById(fieldId);
    const errorSpan = document.getElementById(errorId);
    const value = parseFloat(field.value);
    if (isNaN(value) || value < 0) {
        field.classList.add('error');
        errorSpan.textContent = message;
        return false;
    }
    field.classList.remove('error');
    errorSpan.textContent = '';
    return true;
}

function validateEmail(fieldId, errorId, message) {
    const field = document.getElementById(fieldId);
    const errorSpan = document.getElementById(errorId);
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (field.value.trim() === '') { // Permite email vazio
        field.classList.remove('error');
        errorSpan.textContent = '';
        return true;
    }
    if (!emailRegex.test(field.value.trim())) {
        field.classList.add('error');
        errorSpan.textContent = message;
        return false;
    }
    field.classList.remove('error');
    errorSpan.textContent = '';
    return true;
}

function validateSelect(fieldId, errorId, message) {
    const field = document.getElementById(fieldId);
    const errorSpan = document.getElementById(errorId);
    if (field.value === '' || field.value === 'null') { // Checa se a opção padrão está selecionada
        field.classList.add('error');
        errorSpan.textContent = message;
        return false;
    }
    field.classList.remove('error');
    errorSpan.textContent = '';
    return true;
}

// Função para aplicar máscara de telefone
function applyPhoneMask(inputElement) {
    inputElement.addEventListener('input', (e) => {
        let value = e.target.value.replace(/\D/g, ''); // Remove tudo que não é dígito
        let maskedValue = '';

        if (value.length > 0) {
            maskedValue += '(' + value.substring(0, 2);
        }
        if (value.length >= 3) {
            maskedValue += ') ' + value.substring(2, 7);
        }
        if (value.length >= 8) {
            maskedValue += '-' + value.substring(7, 11);
        }
        e.target.value = maskedValue;
    });
}

// ============== MODAL DE CONFIRMAÇÃO PERSONALIZADO =============
let resolveModalPromise;

function showConfirmationModal(title, message) {
    const modal = document.getElementById('confirmationModal');
    document.getElementById('modalTitle').textContent = title;
    document.getElementById('modalMessage').textContent = message;
    modal.style.display = 'flex'; // Mostra o modal

    return new Promise((resolve) => {
        resolveModalPromise = resolve;
    });
}

document.getElementById('modalConfirmBtn').onclick = () => {
    document.getElementById('confirmationModal').style.display = 'none';
    resolveModalPromise(true);
};

document.getElementById('modalCancelBtn').onclick = () => {
    document.getElementById('confirmationModal').style.display = 'none';
    resolveModalPromise(false);
};

// ============== MODAL DE PAGAMENTO =============
let resolvePaymentModalPromise;

function showPaymentModal() {
    const modal = document.getElementById('paymentModal');
    document.getElementById('paymentMethod').value = ''; // Limpa a seleção anterior
    document.getElementById('clientDidNotPay').checked = false; // Desmarca "não pagou"
    document.getElementById('paymentMethod').classList.remove('error'); // Remove erros
    document.getElementById('errorPaymentMethod').textContent = ''; // Limpa mensagem de erro
    modal.style.display = 'flex';

    return new Promise((resolve) => {
        resolvePaymentModalPromise = resolve;
    });
}

document.getElementById('confirmPaymentBtn').onclick = () => {
    const paymentMethod = document.getElementById('paymentMethod').value;
    const clientDidNotPay = document.getElementById('clientDidNotPay').checked;

    if (!clientDidNotPay && paymentMethod === '') {
        document.getElementById('paymentMethod').classList.add('error');
        document.getElementById('errorPaymentMethod').textContent = 'Selecione uma forma de pagamento ou marque "Cliente não pagou".';
        return;
    }
    document.getElementById('paymentMethod').classList.remove('error');
    document.getElementById('errorPaymentMethod').textContent = '';

    document.getElementById('paymentModal').style.display = 'none';
    resolvePaymentModalPromise({ paymentMethod, clientDidNotPay });
};

document.getElementById('cancelPaymentBtn').onclick = () => {
    document.getElementById('paymentModal').style.display = 'none';
    resolvePaymentModalPromise(null); // Retorna null se cancelar
};


// ====== CONTROLE DE SEÇÕES E LOGIN =======
document.getElementById("btnEntrar").onclick = () => {
  document.getElementById("splash").style.opacity = 0;
  setTimeout(() => {
    document.getElementById("splash").style.display = "none";
    document.getElementById("loginScreen").style.display = "flex"; // Mostra a tela de login
    document.getElementById("password").focus(); // Foca no campo de senha
  }, 600);
};

document.getElementById("btnLogin").onclick = () => {
    const passwordInput = document.getElementById("password");
    const loginError = document.getElementById("loginError");
    if (passwordInput.value === MASTER_PASSWORD) {
        document.getElementById("loginScreen").style.opacity = 0;
        setTimeout(() => {
            document.getElementById("loginScreen").style.display = "none";
            document.getElementById("main").style.display = "block";
            abrirSecao("dashboardSection"); // Abre o dashboard após o login
        }, 600);
    } else {
        loginError.textContent = "Senha incorreta!";
        loginError.style.display = "block";
        passwordInput.classList.add('error');
        setTimeout(() => {
          loginError.style.display = "none";
          passwordInput.classList.remove('error');
        }, 3000);
    }
};

function abrirSecao(id) {
  document.querySelectorAll("section").forEach(sec => {
    sec.style.display = "none";
  });
  document.getElementById(id).style.display = "block";

  // Recarregar listas e selects ao abrir a seção
  if (id === "clientesSection") {
    listarClientes();
    limparCamposCliente();
    applyPhoneMask(document.getElementById("telefoneCliente"));
  }
  if (id === "profissionaisSection") {
    listarProfissionais();
    limparCamposProfissional();
  }
  if (id === "produtosSection") {
    listarProdutos();
    listarProdutosEmFalta();
    preencherSelectProdutosUso();
    listarMovimentacoes();
    limparCamposProduto();
  }
  if (id === "agendamentosSection") { // Módulo de Agendar (novo agendamento)
    preencherSelectClienteAgendamento();
    preencherSelectProfissionalAgendamento();
    limparCamposAgendamento();
  }
  if (id === "agendadosSection") { // Módulo de Clientes Agendados
    listarTodosAgendamentos(); // Exibe todos os agendamentos (futuros e históricos)
  }
  if (id === "financeiroSection") carregarFinanceiro();
  if (id === "dashboardSection") {
    atualizarDashboard();
    preencherFiltrosFinanceiro();
    desenharGraficoFinanceiro();
    desenharGraficoAgendamentosProfissional();
    desenharGraficoServicosPopulares();
    desenharGraficoNovosClientes();
    listarAgendamentosProximos();
  }
  if (id === "backupSection") { }
}

// ================== CLIENTES ======================
function validarFormCliente() {
    let isValid = true;
    isValid = validateField('nomeCliente', 'errorNomeCliente', 'Nome do cliente é obrigatório.') && isValid;
    isValid = validateEmail('emailCliente', 'errorEmailCliente', 'Email inválido.') && isValid;
    return isValid;
}

function salvarCliente() {
  if (!validarFormCliente()) {
      showToast("Preencha todos os campos obrigatórios corretamente.");
      return;
  }
  const nomeInput = document.getElementById("nomeCliente");
  const telefone = document.getElementById("telefoneCliente").value.trim();
  const email = document.getElementById("emailCliente").value.trim();
  const dataCadastro = document.getElementById("dataCadastroCliente").value || new Date().toISOString().slice(0, 10);
  const obs = document.getElementById("obsCliente").value.trim();

  let dados = { nome: nomeInput.value.trim(), telefone, email, dataCadastro, obs };

  if (clienteEditandoId !== null) {
    const index = clientes.findIndex(c => c.id === clienteEditandoId);
    if (index !== -1) {
      clientes[index] = { ...clientes[index], ...dados };
      showToast("Cliente atualizado com sucesso!");
    }
    clienteEditandoId = null;
  } else {
    dados.id = generateUUID();
    clientes.push(dados);
    showToast("Cliente salvo com sucesso!");
  }
  localStorage.setItem("clientes", JSON.stringify(clientes));
  listarClientes();
  limparCamposCliente();
  atualizarDashboard();
  desenharGraficoNovosClientes();
  preencherSelectClienteAgendamento(); // Atualiza o select de clientes nos agendamentos
  listarTodosAgendamentos(); // Atualiza a lista de agendamentos se houver clientes novos/editados
}
function limparCamposCliente() {
  document.getElementById("nomeCliente").value = "";
  document.getElementById("telefoneCliente").value = "";
  document.getElementById("emailCliente").value = "";
  document.getElementById("dataCadastroCliente").value = "";
  document.getElementById("obsCliente").value = "";
  document.getElementById("nomeCliente").classList.remove('error');
  document.getElementById("errorNomeCliente").textContent = '';
  document.getElementById("emailCliente").classList.remove('error');
  document.getElementById("errorEmailCliente").textContent = '';
  clienteEditandoId = null;
}
function listarClientes() {
  const busca = document.getElementById("buscaCliente").value.toLowerCase();
  const lista = document.getElementById("listaClientes");
  lista.innerHTML = "";
  clientes.forEach(c => {
    if (!c.nome.toLowerCase().includes(busca)) return;
    lista.innerHTML += `
    <div class="item">
      <strong>${c.nome}</strong> <small>${c.telefone || ""} | ${c.email || ""}</small><br>
      <small>Cadastro: ${c.dataCadastro || "N/A"}</small><br>
      <small>${c.obs || ""}</small>
      <div>
          <button class="editar" onclick="editarCliente('${c.id}')">Editar</button>
          <button class="excluir" onclick="confirmarExclusao('cliente', '${c.id}', '${c.nome}')">Excluir</button>
      </div>
    </div>`;
  });
}
function editarCliente(id) {
  const c = clientes.find(cliente => cliente.id === id);
  if (c) {
    document.getElementById("nomeCliente").value = c.nome;
    document.getElementById("telefoneCliente").value = c.telefone;
    document.getElementById("emailCliente").value = c.email;
    document.getElementById("dataCadastroCliente").value = c.dataCadastro || "";
    document.getElementById("obsCliente").value = c.obs;
    clienteEditandoId = c.id;
    document.getElementById("nomeCliente").focus();
  }
}
function excluirCliente(id) {
    agendamentos = agendamentos.filter(a => a.clienteId !== id); // Remove agendamentos do cliente
    clientes = clientes.filter(c => c.id !== id);
    localStorage.setItem("agendamentos", JSON.stringify(agendamentos));
    localStorage.setItem("clientes", JSON.stringify(clientes));
    listarClientes();
    atualizarDashboard();
    desenharGraficoNovosClientes();
    showToast("Cliente excluído!");
    preencherSelectClienteAgendamento(); // Atualiza o select de clientes
    listarTodosAgendamentos(); // Atualiza a lista de agendamentos
    carregarFinanceiro(); // Recalcula ganhos
}

// ================== PROFISSIONAIS ======================
function validarFormProfissional() {
    let isValid = true;
    isValid = validateField('nomeProf', 'errorNomeProf', 'Nome do profissional é obrigatório.') && isValid;
    isValid = validateField('espProf', 'errorEspProf', 'Especialidade é obrigatória.') && isValid;
    isValid = validateField('servicoProf', 'errorServicoProf', 'Serviço é obrigatório.') && isValid;
    isValid = validateNumber('valorProf', 'errorValorProf', 'Valor do serviço é obrigatório e deve ser positivo.') && isValid;
    return isValid;
}

function salvarProfissional() {
  if (!validarFormProfissional()) {
      showToast("Preencha todos os campos obrigatórios corretamente.");
      return;
  }
  const nomeInput = document.getElementById("nomeProf");
  const espInput = document.getElementById("espProf");
  const servicoNomeInput = document.getElementById("servicoProf");
  const valorProfInput = document.getElementById("valorProf");

  let servicos = [{ nome: servicoNomeInput.value.trim(), valor: parseFloat(valorProfInput.value) }];
  let dados = { nome: nomeInput.value.trim(), especialidade: espInput.value.trim(), servicos };

  if (profissionalEditandoId !== null) {
    const index = profissionais.findIndex(p => p.id === profissionalEditandoId);
    if (index !== -1) {
      // Para edição, podemos permitir adicionar mais serviços ou apenas editar o primeiro
      // Por simplicidade, vamos editar apenas o primeiro serviço aqui.
      // Se houvesse múltiplos, a lógica seria mais complexa.
      if (profissionais[index].servicos && profissionais[index].servicos.length > 0) {
          profissionais[index].servicos[0] = servicos[0];
      } else {
          profissionais[index].servicos = servicos;
      }
      profissionais[index].nome = dados.nome;
      profissionais[index].especialidade = dados.especialidade;

      showToast("Profissional atualizado com sucesso!");
    }
    profissionalEditandoId = null;
  } else {
    dados.id = generateUUID();
    profissionais.push(dados);
    showToast("Profissional salvo com sucesso!");
  }
  localStorage.setItem("profissionais", JSON.stringify(profissionais));
  listarProfissionais();
  limparCamposProfissional();
  atualizarDashboard();
  desenharGraficoAgendamentosProfissional();
  preencherSelectProfissionalAgendamento(); // Atualiza select de agendamentos
  listarTodosAgendamentos(); // Atualiza a lista de agendamentos se houver profs novos/editados
}
function limparCamposProfissional() {
  document.getElementById("nomeProf").value = "";
  document.getElementById("espProf").value = "";
  document.getElementById("servicoProf").value = "";
  document.getElementById("valorProf").value = "";
  document.getElementById("nomeProf").classList.remove('error');
  document.getElementById("errorNomeProf").textContent = '';
  document.getElementById("espProf").classList.remove('error');
  document.getElementById("errorEspProf").textContent = '';
  document.getElementById("servicoProf").classList.remove('error');
  document.getElementById("errorServicoProf").textContent = '';
  document.getElementById("valorProf").classList.remove('error');
  document.getElementById("errorValorProf").textContent = '';
  profissionalEditandoId = null;
}
function listarProfissionais() {
  const busca = document.getElementById("buscaProfissional").value.toLowerCase();
  const lista = document.getElementById("listaProfissionais");
  lista.innerHTML = "";
  profissionais.forEach(p => {
    if (!p.nome.toLowerCase().includes(busca)) return;
    let servicosHTML = p.servicos.map(s => `<li>${s.nome} - ${currencyFormatter.format(s.valor)}</li>`).join("");
    lista.innerHTML += `
    <div class="item">
      <strong>${p.nome}</strong> <small>(${p.especialidade})</small>
      <ul>${servicosHTML}</ul>
      <div>
          <button class="editar" onclick="editarProfissional('${p.id}')">Editar</button>
          <button class="excluir" onclick="confirmarExclusao('profissional', '${p.id}', '${p.nome}')">Excluir</button>
      </div>
    </div>`;
  });
}
function editarProfissional(id) {
  const p = profissionais.find(prof => prof.id === id);
  if (p) {
    document.getElementById("nomeProf").value = p.nome;
    document.getElementById("espProf").value = p.especialidade;
    // Assume que só estamos editando o primeiro serviço por enquanto
    document.getElementById("servicoProf").value = p.servicos[0]?.nome || "";
    document.getElementById("valorProf").value = p.servicos[0]?.valor || "";
    profissionalEditandoId = p.id;
    document.getElementById("nomeProf").focus();
  }
}
function excluirProfissional(id) {
    agendamentos = agendamentos.filter(a => a.profId !== id); // Remove agendamentos do profissional
    profissionais = profissionais.filter(p => p.id !== id);
    localStorage.setItem("agendamentos", JSON.stringify(agendamentos));
    localStorage.setItem("profissionais", JSON.stringify(profissionais));
    listarProfissionais();
    atualizarDashboard();
    desenharGraficoAgendamentosProfissional();
    preencherSelectProfissionalAgendamento(); // Atualiza select de agendamentos
    showToast("Profissional excluído!");
    listarTodosAgendamentos(); // Atualiza a lista de agendamentos
    carregarFinanceiro(); // Recalcula ganhos
}

// ================== PRODUTOS (Estoque avançado) ======================
function validarFormProduto() {
    let isValid = true;
    isValid = validateField('nomeProduto', 'errorNomeProduto', 'Nome do produto é obrigatório.') && isValid;
    isValid = validateField('tipoProduto', 'errorTipoProduto', 'Tipo do produto é obrigatório.') && isValid;
    isValid = validateNumber('quantidadeProduto', 'errorQuantidadeProduto', 'Quantidade é obrigatória e deve ser positiva.') && isValid;
    isValid = validateNumber('minQuantidadeProduto', 'errorMinQuantidadeProduto', 'Quantidade mínima é obrigatória e deve ser positiva.') && isValid;
    return isValid;
}

function salvarProduto() {
  if (!validarFormProduto()) {
      showToast("Preencha todos os campos obrigatórios corretamente.");
      return;
  }
  const nomeInput = document.getElementById("nomeProduto");
  const tipoInput = document.getElementById("tipoProduto");
  const quantidadeInput = document.getElementById("quantidadeProduto");
  const minQtdInput = document.getElementById("minQuantidadeProduto");
  const validade = document.getElementById("validadeProduto").value;

  let dados = {
      nome: nomeInput.value.trim(),
      tipo: tipoInput.value.trim(),
      quantidade: parseInt(quantidadeInput.value),
      minQtd: parseInt(minQtdInput.value),
      validade
  };

  if (produtoEditandoId !== null) {
    const index = produtos.findIndex(p => p.id === produtoEditandoId);
    if (index !== -1) {
      // Ao editar, queremos manter o histórico de movimentações, mas atualizar as outras propriedades
      dados.movimentacoes = produtos[index].movimentacoes || [];
      produtos[index] = { ...produtos[index], ...dados };
      showToast("Produto atualizado com sucesso!");
    }
    produtoEditandoId = null;
  } else {
    dados.id = generateUUID();
    dados.movimentacoes = [];
    produtos.push(dados);
    showToast("Produto salvo com sucesso!");
  }

  localStorage.setItem("produtos", JSON.stringify(produtos));
  limparCamposProduto();
  listarProdutos();
  listarProdutosEmFalta();
  preencherSelectProdutosUso();
  listarMovimentacoes();
  atualizarDashboard();
}
function limparCamposProduto() {
  document.getElementById("nomeProduto").value = "";
  document.getElementById("tipoProduto").value = "";
  document.getElementById("quantidadeProduto").value = "";
  document.getElementById("minQuantidadeProduto").value = "";
  document.getElementById("validadeProduto").value = "";
  document.getElementById("nomeProduto").classList.remove('error');
  document.getElementById("errorNomeProduto").textContent = '';
  document.getElementById("tipoProduto").classList.remove('error');
  document.getElementById("errorTipoProduto").textContent = '';
  document.getElementById("quantidadeProduto").classList.remove('error');
  document.getElementById("errorQuantidadeProduto").textContent = '';
  document.getElementById("minQuantidadeProduto").classList.remove('error');
  document.getElementById("errorMinQuantidadeProduto").textContent = '';
  produtoEditandoId = null;
}
function listarProdutos() {
  const busca = document.getElementById("buscaProduto").value.toLowerCase();
  const lista = document.getElementById("listaProdutos");
  lista.innerHTML = "";
  produtos.forEach(p => {
    if (!p.nome.toLowerCase().includes(busca)) return;
    const validadeText = p.validade ? ` | Validade: ${p.validade}` : "";
    lista.innerHTML += `
    <div class="item">
      <strong>${p.nome}</strong> <small>(${p.tipo})</small><br>
      <small>Quantidade: ${p.quantidade} | Mínimo: ${p.minQtd}${validadeText}</small><br>
      <div>
          <button class="editar" onclick="editarProduto('${p.id}')">Editar</button>
          <button class="excluir" onclick="confirmarExclusao('produto', '${p.id}', '${p.nome}')">Excluir</button>
      </div>
    </div>`;
  });
}
function listarProdutosEmFalta() {
  const div = document.getElementById("produtosEmFalta");
  div.innerHTML = "";
  const emFalta = produtos.filter(p => p.quantidade < p.minQtd);
  if (emFalta.length === 0) {
    div.textContent = "Nenhum produto em falta.";
    return;
  }
  emFalta.forEach(p => {
    div.innerHTML += `<div class="item"><strong>${p.nome}</strong> - Quantidade: ${p.quantidade} (mínimo: ${p.minQtd})</div>`;
  });
}
function editarProduto(id) {
  const p = produtos.find(produto => produto.id === id);
  if (p) {
    document.getElementById("nomeProduto").value = p.nome;
    document.getElementById("tipoProduto").value = p.tipo;
    document.getElementById("quantidadeProduto").value = p.quantidade;
    document.getElementById("minQuantidadeProduto").value = p.minQtd;
    document.getElementById("validadeProduto").value = p.validade || "";
    produtoEditandoId = p.id;
    document.getElementById("nomeProduto").focus();
  }
}
function excluirProduto(id) {
    produtos = produtos.filter(p => p.id !== id);
    localStorage.setItem("produtos", JSON.stringify(produtos));
    listarProdutos();
    listarProdutosEmFalta();
    preencherSelectProdutosUso();
    listarMovimentacoes();
    atualizarDashboard();
    showToast("Produto excluído!");
}
function preencherSelectProdutosUso() {
  const select = document.getElementById("selectProdutoUso");
  select.innerHTML = "<option value=''>-- Selecione um produto --</option>";
  produtos.forEach(p => {
    select.innerHTML += `<option value="${p.id}">${p.nome} (Qtd: ${p.quantidade})</option>`;
  });
}
function usarProduto() {
  const select = document.getElementById("selectProdutoUso");
  const produtoId = select.value;
  const qtdUsoInput = document.getElementById("quantidadeUso");
  const qtdUso = parseInt(qtdUsoInput.value);

  if (!produtoId) {
    return showToast("Selecione um produto válido.");
  }
  if (isNaN(qtdUso) || qtdUso <= 0) {
    return showToast("Informe uma quantidade válida para uso.");
  }

  const produto = produtos.find(p => p.id === produtoId);
  if (!produto) return showToast("Produto não encontrado.");

  if (produto.quantidade < qtdUso) {
    return showToast("Quantidade insuficiente em estoque.");
  }

  produto.quantidade -= qtdUso;
  const hoje = new Date().toISOString().slice(0,10);
  produto.movimentacoes.push({
    id: generateUUID(),
    tipo: "Saída",
    quantidade: qtdUso,
    data: hoje,
    descricao: "Uso no salão"
  });

  localStorage.setItem("produtos", JSON.stringify(produtos));
  listarProdutos();
  listarProdutosEmFalta();
  preencherSelectProdutosUso();
  listarMovimentacoes();
  qtdUsoInput.value = "";
  select.value = "";
  atualizarDashboard();
  showToast(`Usado ${qtdUso} de ${produto.nome}.`);
}
function listarMovimentacoes() {
  const div = document.getElementById("historicoMovimentacoes");
  div.innerHTML = "";
  // Filtra produtos que realmente possuem movimentações
  const produtosComMovimentacao = produtos.filter(p => p.movimentacoes && p.movimentacoes.length > 0);

  if (produtosComMovimentacao.length === 0) {
      div.innerHTML = "<div class='item'>Nenhuma movimentação de produto registrada.</div>";
      return;
  }

  produtosComMovimentacao.forEach((p) => {
    div.innerHTML += `<h5>${p.nome}</h5>`;
    // Ordena as movimentações por data decrescente
    p.movimentacoes.sort((a,b) => new Date(b.data) - new Date(a.data));
    p.movimentacoes.forEach(m => {
      div.innerHTML += `<div class="item"><strong>${m.data}</strong> - ${m.tipo}: ${m.quantidade} - ${m.descricao || ''}</div>`;
    });
  });
}

// ================== AGENDAMENTOS (Criação) ======================
function validarFormAgendamento() {
    let isValid = true;
    isValid = validateSelect('selectClienteAgendamento', 'errorSelectClienteAgendamento', 'Selecione um cliente.') && isValid;
    isValid = validateSelect('selectProfissionalAgendamento', 'errorSelectProfissionalAgendamento', 'Selecione um profissional.') && isValid;
    isValid = validateSelect('selectServicoAgendamento', 'errorSelectServicoAgendamento', 'Selecione um serviço.') && isValid;
    isValid = validateField('dataAgendamento', 'errorDataAgendamento', 'Data é obrigatória.') && isValid;
    isValid = validateField('horaAgendamento', 'errorHoraAgendamento', 'Hora é obrigatória.') && isValid;

    // Validação adicional: data do agendamento não pode ser no passado (apenas para novos agendamentos)
    if (document.getElementById("agendamentoEditandoId").value === "") { // Só valida para novos
        const dataAgendamento = new Date(document.getElementById("dataAgendamento").value + 'T' + document.getElementById("horaAgendamento").value);
        const hoje = new Date();
        hoje.setSeconds(0,0); // Ignora segundos e milissegundos para comparação
        if (dataAgendamento < hoje) {
            document.getElementById('dataAgendamento').classList.add('error');
            document.getElementById('errorDataAgendamento').textContent = 'Agendamento não pode ser no passado.';
            isValid = false;
        } else {
            document.getElementById('dataAgendamento').classList.remove('error');
            document.getElementById('errorDataAgendamento').textContent = '';
        }
    }
    return isValid;
}

function preencherSelectClienteAgendamento() {
  const select = document.getElementById("selectClienteAgendamento");
  select.innerHTML = "<option value=''>-- Selecione um cliente --</option>";
  clientes.forEach(c => {
    select.innerHTML += `<option value="${c.id}">${c.nome}</option>`;
  });
}
function preencherSelectProfissionalAgendamento() {
  const select = document.getElementById("selectProfissionalAgendamento");
  select.innerHTML = "<option value=''>-- Selecione um profissional --</option>";
  profissionais.forEach(p => {
    select.innerHTML += `<option value="${p.id}">${p.nome}</option>`;
  });
  document.getElementById("selectServicoAgendamento").innerHTML = "<option value=''>-- Selecione o serviço --</option>";
}
function atualizarServicosProfissional() {
  const profId = document.getElementById("selectProfissionalAgendamento").value;
  const selectServico = document.getElementById("selectServicoAgendamento");
  selectServico.innerHTML = "<option value=''>-- Selecione o serviço --</option>";
  const profissional = profissionais.find(p => p.id === profId);
  if (!profissional) return;
  
  profissional.servicos.forEach((s, i) => {
    selectServico.innerHTML += `<option value="${i}">${s.nome} - ${currencyFormatter.format(s.valor)}</option>`;
  });
}
function salvarAgendamento() {
  if (!validarFormAgendamento()) {
      showToast("Preencha todos os campos obrigatórios corretamente.");
      return;
  }
  const clienteId = document.getElementById("selectClienteAgendamento").value;
  const profId = document.getElementById("selectProfissionalAgendamento").value;
  const servIndex = parseInt(document.getElementById("selectServicoAgendamento").value);
  const data = document.getElementById("dataAgendamento").value;
  const hora = document.getElementById("horaAgendamento").value;

  let agendamento = {
    id: generateUUID(),
    clienteId,
    profId,
    servIndex: servIndex,
    data,
    hora,
    status: "Pendente",
    formaPagamento: "", // Novo campo
    naoPagou: false, // Novo campo
    dataConclusao: "", // Novo campo para data da conclusão/pagamento
    dataCriacao: new Date().toISOString().slice(0, 10)
  };

  if (document.getElementById("agendamentoEditandoId").value !== "") {
      const agendamentoIdToEdit = document.getElementById("agendamentoEditandoId").value;
      const index = agendamentos.findIndex(a => a.id === agendamentoIdToEdit);
      if (index !== -1) {
          // Mantém o status, formaPagamento, naoPagou e dataConclusao originais na edição, se não forem alterados
          agendamentos[index] = { ...agendamentos[index], ...agendamento, id: agendamentoIdToEdit };
          showToast("Agendamento atualizado com sucesso!");
      }
      document.getElementById("agendamentoEditandoId").value = "";
  } else {
      agendamentos.push(agendamento);
      showToast("Agendamento salvo com sucesso!");
  }
  
  localStorage.setItem("agendamentos", JSON.stringify(agendamentos));
  listarTodosAgendamentos(); // Atualiza a nova lista de agendamentos
  atualizarDashboard();
  carregarFinanceiro();
  limparCamposAgendamento();
  desenharGraficoServicosPopulares();
  desenharGraficoAgendamentosProfissional();
  listarAgendamentosProximos();
}

function limparCamposAgendamento() {
    document.getElementById("selectClienteAgendamento").value = "";
    document.getElementById("selectProfissionalAgendamento").value = "";
    document.getElementById("selectServicoAgendamento").innerHTML = "<option value=''>-- Selecione o serviço --</option>";
    document.getElementById("dataAgendamento").value = "";
    document.getElementById("horaAgendamento").value = "";
    document.getElementById("agendamentoEditandoId").value = ""; // Limpa ID de edição

    document.getElementById("selectClienteAgendamento").classList.remove('error');
    document.getElementById("errorSelectClienteAgendamento").textContent = '';
    document.getElementById("selectProfissionalAgendamento").classList.remove('error');
    document.getElementById("errorSelectProfissionalAgendamento").textContent = '';
    document.getElementById("selectServicoAgendamento").classList.remove('error');
    document.getElementById("errorSelectServicoAgendamento").textContent = '';
    document.getElementById("dataAgendamento").classList.remove('error');
    document.getElementById("errorDataAgendamento").textContent = '';
    document.getElementById("horaAgendamento").classList.remove('error');
    document.getElementById("errorHoraAgendamento").textContent = '';
}

// ================== AGENDAMENTOS (Visualização e Gerenciamento - Novo Módulo) ======================
async function alterarStatusAgendamento(id) {
  const agendamento = agendamentos.find(a => a.id === id);
  if (!agendamento) return;

  if (agendamento.status === "Pendente") {
      // Se está pendente, vamos concluir
      currentAgendamentoIdForPayment = id; // Armazena o ID do agendamento
      const paymentDetails = await showPaymentModal();

      if (paymentDetails === null) { // Usuário cancelou o modal de pagamento
          showToast("Conclusão do agendamento cancelada.");
          currentAgendamentoIdForPayment = null;
          return;
      }

      agendamento.status = "Concluído";
      agendamento.dataConclusao = new Date().toISOString().slice(0, 10);
      agendamento.formaPagamento = paymentDetails.clientDidNotPay ? "Não Pagou" : paymentDetails.paymentMethod;
      agendamento.naoPagou = paymentDetails.clientDidNotPay;

      showToast("Agendamento concluído!");

  } else if (agendamento.status === "Concluído") {
      // Se já está concluído, vamos reabrir
      const confirmReopen = await showConfirmationModal(
          "Reabrir Agendamento",
          "Tem certeza que deseja reabrir este agendamento? Ele será marcado como Pendente e removido dos ganhos."
      );
      if (!confirmReopen) {
          showToast("Reabertura do agendamento cancelada.");
          return;
      }

      agendamento.status = "Pendente";
      agendamento.formaPagamento = ""; // Limpa forma de pagamento
      agendamento.naoPagou = false; // Define como não pagou
      agendamento.dataConclusao = ""; // Limpa data de conclusão
      showToast("Agendamento reaberto!");
  }
  
  localStorage.setItem("agendamentos", JSON.stringify(agendamentos));
  listarTodosAgendamentos(); // Atualiza a nova lista de agendamentos
  carregarFinanceiro();
  atualizarDashboard();
  desenharGraficoServicosPopulares();
  desenharGraficoAgendamentosProfissional();
  listarAgendamentosProximos();
  currentAgendamentoIdForPayment = null; // Limpa o ID após o processamento
}

// Nova função para listar todos os agendamentos (futuros e passados, concluídos ou pendentes)
function listarTodosAgendamentos() {
  const busca = document.getElementById("buscaTodosAgendamentos").value.toLowerCase();
  const filtroPendentes = document.getElementById("filtroAgendadosPendentes").checked;
  const filtroData = document.getElementById("filtroAgendadosData").value;

  const lista = document.getElementById("listaTodosAgendamentos");
  lista.innerHTML = "";

  const agendamentosExibidos = agendamentos.filter(a => {
      const clienteNome = clientes.find(c => c.id === a.clienteId)?.nome || "";
      if (!clienteNome.toLowerCase().includes(busca)) return false;

      // Se o filtroPendentes estiver marcado, mostra APENAS os pendentes/futuros
      // Se a data do agendamento é HOJE ou no FUTURO E o status é PENDENTE, ou se for NOVO e o status é PENDENTE
      const agendamentoDateTime = new Date(`${a.data}T${a.hora}`);
      const hoje = new Date();
      hoje.setHours(0,0,0,0); // Normaliza para comparar apenas a data

      if (filtroPendentes) {
        if (a.status !== "Pendente" || agendamentoDateTime < hoje) return false;
      }

      if (filtroData && a.data !== filtroData) return false;
      return true;
  }).sort((a,b) => {
      // Ordena por data e hora para manter a sequência cronológica
      const dateTimeA = new Date(`${a.data}T${a.hora}`);
      const dateTimeB = new Date(`${b.data}T${b.hora}`);
      return dateTimeA - dateTimeB;
  });

  if (agendamentosExibidos.length === 0) {
      lista.innerHTML = "<div class='item'>Nenhum agendamento encontrado para os filtros aplicados.</div>";
      return;
  }

  agendamentosExibidos.forEach(a => {
    const clienteNome = clientes.find(c => c.id === a.clienteId)?.nome || "Cliente Removido";
    const profissional = profissionais.find(p => p.id === a.profId);
    const servico = profissional?.servicos[a.servIndex];

    let statusText = a.status;
    let statusClass = '';
    let pagamentoInfo = '';
    let actionButton = '';

    if (a.status === 'Concluído') {
        statusClass = 'status-concluido';
        if (a.naoPagou) {
            statusText = 'Não Pagou';
            statusClass = 'status-nao-pagou';
        } else if (a.formaPagamento) {
            pagamentoInfo = `<br>Pagamento: ${a.formaPagamento}`;
        }
        actionButton = `<button class="info" onclick="alterarStatusAgendamento('${a.id}')">Reabrir</button>`;
    } else if (a.status === 'Pendente') {
        statusClass = 'status-pendente';
        actionButton = `<button onclick="alterarStatusAgendamento('${a.id}')">Concluir</button>`;
    }

    lista.innerHTML += `
    <div class="item">
      <strong>${clienteNome}</strong> - ${a.data} ${a.hora} <br>
      Profissional: ${profissional?.nome || "N/A"}<br>
      Serviço: ${servico?.nome || "N/A"} - ${currencyFormatter.format(servico?.valor || 0)}<br>
      Status: <span class="${statusClass}">${statusText}</span> ${pagamentoInfo}
      <div>
          <button class="editar" onclick="editarAgendamentoParaCriacao('${a.id}')">Editar</button>
          <button class="excluir" onclick="confirmarExclusao('agendamento', '${a.id}', 'de ${clienteNome} em ${a.data} ${a.hora}')">Excluir</button>
          ${actionButton}
      </div>
    </div>`;
  });
}

function editarAgendamentoParaCriacao(id) {
    const a = agendamentos.find(agend => agend.id === id);
    if (a) {
        document.getElementById("selectClienteAgendamento").value = a.clienteId;
        document.getElementById("selectProfissionalAgendamento").value = a.profId;
        atualizarServicosProfissional();
        document.getElementById("selectServicoAgendamento").value = a.servIndex;
        document.getElementById("dataAgendamento").value = a.data;
        document.getElementById("horaAgendamento").value = a.hora;
        document.getElementById("agendamentoEditandoId").value = a.id;
        showToast("Editando agendamento. Salve para confirmar.");
        abrirSecao('agendamentosSection'); // Volta para a seção de criação/edição
    }
}


function excluirAgendamento(id) {
    agendamentos = agendamentos.filter(a => a.id !== id);
    localStorage.setItem("agendamentos", JSON.stringify(agendamentos));
    listarTodosAgendamentos(); // Atualiza a nova lista de agendamentos
    atualizarDashboard();
    carregarFinanceiro();
    desenharGraficoServicosPopulares();
    desenharGraficoAgendamentosProfissional();
    listarAgendamentosProximos();
    showToast("Agendamento excluído!");
}

function limparFiltrosTodosAgendamentos() {
  document.getElementById("buscaTodosAgendamentos").value = "";
  document.getElementById("filtroAgendadosPendentes").checked = true;
  document.getElementById("filtroAgendadosData").value = "";
  listarTodosAgendamentos();
}


// ================== FINANCEIRO ======================
function salvarCaixaInicial() {
  if (!validateNumber('caixaInicial', 'errorCaixaInicial', 'Valor do caixa inicial deve ser positivo.')) {
      showToast("Valor inválido para o caixa inicial.");
      return;
  }
  const valor = parseFloat(document.getElementById("caixaInicial").value);
  caixaInicial = valor;
  localStorage.setItem("caixaInicial", caixaInicial);
  showToast("Caixa inicial salvo.");
  atualizarDashboard();
  carregarFinanceiro();
  desenharGraficoFinanceiro();
}

function carregarFinanceiro() {
  document.getElementById("caixaInicial").value = caixaInicial.toFixed(2);

  // Ganhos = soma dos agendamentos concluídos E PAGOS
  let ganhos = 0;
  let ganhosHTML = "";
  agendamentos.forEach(a => {
    if (a.status === "Concluído" && !a.naoPagou) { // Só considera ganho se concluído E pago
      const prof = profissionais.find(p => p.id === a.profId);
      const serv = prof?.servicos[a.servIndex];
      if (serv) {
        ganhos += serv.valor;
        const clienteNome = clientes.find(c => c.id === a.clienteId)?.nome || "N/A";
        const formaPagamento = a.formaPagamento || "N/A";
        ganhosHTML += `<div class="item"><strong>${clienteNome}</strong> - ${a.dataConclusao} - ${serv.nome} - ${currencyFormatter.format(serv.valor)} (${formaPagamento})</div>`;
      }
    }
  });
  document.getElementById("listaGanhos").innerHTML = ganhosHTML || "<div class='item'>Nenhum ganho registrado.</div>";

  // Gastos
  let gastosTotal = 0;
  let gastosHTML = "";
  gastos.forEach(g => {
    gastosTotal += g.valor;
    gastosHTML += `<div class="item"><strong>${g.data}</strong> - ${g.descricao} - ${currencyFormatter.format(g.valor)}</div>`;
  });
  document.getElementById("listaGastos").innerHTML = gastosHTML || "<div class='item'>Nenhum gasto registrado.</div>";

  // Atualizar resumo financeiro
  const lucro = caixaInicial + ganhos - gastosTotal;
  document.getElementById("caixaAtual").textContent = currencyFormatter.format(lucro);
  document.getElementById("ganhosTotais").textContent = currencyFormatter.format(ganhos);
  document.getElementById("gastosTotais").textContent = currencyFormatter.format(gastosTotal);
  document.getElementById("lucroTotal").textContent = currencyFormatter.format(lucro);
}
function validarFormGasto() {
    let isValid = true;
    isValid = validateField('descricaoGasto', 'errorDescricaoGasto', 'Descrição do gasto é obrigatória.') && isValid;
    isValid = validateNumber('valorGasto', 'errorValorGasto', 'Valor do gasto é obrigatório e deve ser positivo.') && isValid;
    isValid = validateField('dataGasto', 'errorDataGasto', 'Data do gasto é obrigatória.') && isValid;
    return isValid;
}

function salvarGasto() {
  if (!validarFormGasto()) {
      showToast("Preencha todos os campos obrigatórios corretamente.");
      return;
  }
  const descricaoInput = document.getElementById("descricaoGasto");
  const valorGastoInput = document.getElementById("valorGasto");
  const dataGastoInput = document.getElementById("dataGasto");

  gastos.push({ id: generateUUID(), descricao: descricaoInput.value.trim(), valor: parseFloat(valorGastoInput.value), data: dataGastoInput.value });
  localStorage.setItem("gastos", JSON.stringify(gastos));
  carregarFinanceiro();
  atualizarDashboard();
  desenharGraficoFinanceiro();

  descricaoInput.value = "";
  valorGastoInput.value = "";
  dataGastoInput.value = "";
  showToast("Gasto salvo com sucesso!");
}

// =========== DASHBOARD ==============
function atualizarDashboard() {
  document.getElementById("dashTotalClientes").textContent = clientes.length;
  document.getElementById("dashTotalProfissionais").textContent = profissionais.length;
  document.getElementById("dashTotalProdutos").textContent = produtos.reduce((acc, p) => acc + p.quantidade, 0);
  document.getElementById("dashTotalAgendamentos").textContent = agendamentos.filter(a => a.status === "Pendente").length;
  
  const ganhosCalculados = agendamentos.reduce((acc,a) => {
    if(a.status === "Concluído" && !a.naoPagou){ // Apenas agendamentos concluídos E pagos
      const prof = profissionais.find(p => p.id === a.profId);
      if(prof && prof.servicos[a.servIndex]){
        return acc + prof.servicos[a.servIndex].valor;
      }
    }
    return acc;
  }, 0);
  const gastosCalculados = gastos.reduce((acc,g) => acc + g.valor, 0);
  const lucroTotal = caixaInicial + ganhosCalculados - gastosCalculados;
  document.getElementById("dashCaixaAtual").textContent = currencyFormatter.format(lucroTotal);

  // Calcular ganhos, gastos e lucro do mês atual
  const hoje = new Date();
  const mesAtual = (hoje.getMonth() + 1).toString().padStart(2, '0');
  const anoAtual = hoje.getFullYear().toString();
  const mesAnoAtual = `${anoAtual}-${mesAtual}`;

  let ganhosMesAtual = 0;
  agendamentos.forEach(a => {
      if (a.status === "Concluído" && !a.naoPagou && a.dataConclusao.startsWith(mesAnoAtual)) { // Usa dataConclusao
          const prof = profissionais.find(p => p.id === a.profId);
          const serv = prof?.servicos[a.servIndex];
          if (serv) {
              ganhosMesAtual += serv.valor;
          }
      }
  });

  let gastosMesAtual = 0;
  gastos.forEach(g => {
      if (g.data.startsWith(mesAnoAtual)) {
          gastosMesAtual += g.valor;
      }
  });

  const lucroMesAtual = ganhosMesAtual - gastosMesAtual;

  document.getElementById("dashGanhosMensal").textContent = currencyFormatter.format(ganhosMesAtual);
  document.getElementById("dashGastosMensal").textContent = currencyFormatter.format(gastosMesAtual);
  document.getElementById("dashLucroMensal").textContent = currencyFormatter.format(lucroMesAtual);

  // Alerta de Produtos em Falta no Dashboard
  const produtosEmFalta = produtos.filter(p => p.quantidade < p.minQtd);
  const dashAlertCard = document.getElementById("dashAlertProdutosEmFalta");
  const dashQtdProdutosEmFalta = document.getElementById("dashQtdProdutosEmFalta");

  dashQtdProdutosEmFalta.textContent = produtosEmFalta.length;
  if (produtosEmFalta.length > 0) {
      dashAlertCard.style.display = 'flex';
      dashAlertCard.classList.add('card-alert');
      showToast(`Atenção: ${produtosEmFalta.length} produto(s) em falta!`, 5000);
  } else {
      dashAlertCard.style.display = 'none';
      dashAlertCard.classList.remove('card-alert');
  }
}


// ======= GRÁFICOS DO DASHBOARD ========
let chartFinanceiro = null;
let chartAgendamentosProfissional = null;
let chartServicosPopulares = null;
let chartNovosClientes = null;

function preencherFiltrosFinanceiro() {
    const filtroMes = document.getElementById('filtroMesFinanceiro');
    const filtroAno = document.getElementById('filtroAnoFinanceiro');

    const hoje = new Date();
    const anoAtual = hoje.getFullYear();
    const mesAtual = (hoje.getMonth() + 1).toString().padStart(2, '0');

    filtroMes.value = `${anoAtual}-${mesAtual}`;

    filtroAno.innerHTML = '<option value="">Todos os Anos</option>';
    const anosUnicos = new Set();
    agendamentos.forEach(a => { if (a.dataConclusao) anosUnicos.add(a.dataConclusao.substring(0, 4)); }); // Usa dataConclusao
    gastos.forEach(g => anosUnicos.add(g.data.substring(0, 4)));

    Array.from(anosUnicos).sort().reverse().forEach(ano => {
        filtroAno.innerHTML += `<option value="${ano}">${ano}</option>`;
    });
    filtroAno.value = "";
}

function resetFiltroFinanceiro() {
    const filtroMes = document.getElementById('filtroMesFinanceiro');
    const filtroAno = document.getElementById('filtroAnoFinanceiro');
    filtroMes.value = "";
    filtroAno.value = "";
    desenharGraficoFinanceiro();
}


function desenharGraficoFinanceiro() {
  const ctx = document.getElementById('graficoFinanceiro').getContext('2d');
  const filtroMes = document.getElementById('filtroMesFinanceiro').value;
  const filtroAno = document.getElementById('filtroAnoFinanceiro').value;

  const ganhosMes = {};
  const gastosMes = {};

  const dadosGanhosFiltrados = agendamentos.filter(a => {
      if (a.status !== "Concluído" || a.naoPagou || !a.dataConclusao) return false; // Apenas concluídos E pagos
      if (filtroMes && !a.dataConclusao.startsWith(filtroMes)) return false;
      if (filtroAno && !a.dataConclusao.startsWith(filtroAno)) return false;
      return true;
  });

  dadosGanhosFiltrados.forEach(a => {
    const prof = profissionais.find(p => p.id === a.profId);
    const serv = prof?.servicos[a.servIndex];
    if (!serv) return;

    const mes = a.dataConclusao.slice(0,7);
    ganhosMes[mes] = (ganhosMes[mes] || 0) + serv.valor;
  });

  const dadosGastosFiltrados = gastos.filter(g => {
      if (filtroMes && !g.data.startsWith(filtroMes)) return false;
      if (filtroAno && !g.data.startsWith(filtroAno)) return false;
      return true;
  });

  dadosGastosFiltrados.forEach(g => {
    const mes = g.data.slice(0,7);
    gastosMes[mes] = (gastosMes[mes] || 0) + g.valor;
  });

  const meses = Array.from(new Set([...Object.keys(ganhosMes), ...Object.keys(gastosMes)])).sort();

  const ganhosData = meses.map(m => ganhosMes[m] || 0);
  const gastosData = meses.map(m => gastosMes[m] || 0);
  const lucroData = meses.map((m, i) => (ganhosData[i] - gastosData[i]));

  if(chartFinanceiro) chartFinanceiro.destroy();

chartFinanceiro = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: meses,
      datasets: [
        {
          label: 'Ganhos',
          data: ganhosData,
          backgroundColor: chartColors.success,
          borderColor: chartColors.success,
          borderWidth: 1,
        },
        {
          label: 'Gastos',
          data: gastosData,
          backgroundColor: chartColors.danger,
          borderColor: chartColors.danger,
          borderWidth: 1,
        },
        {
          label: 'Lucro',
          data: lucroData,
          type: 'line',
          borderColor: chartColors.primary,
          backgroundColor: chartColors.primary,
          borderWidth: 3,
          fill: false,
          tension: 0.3,
          yAxisID: 'y1',
          pointBackgroundColor: chartColors.primary,
          pointBorderColor: '#fff',
          pointRadius: 5,
          pointHoverRadius: 7
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        mode: 'index',
        intersect: false,
      },
      scales: {
        y: {
          beginAtZero: true,
          position: 'left',
          title: {
            display: true,
            text: 'Valor (R$)',
            color: chartColors.dark
          },
          ticks: {
              color: chartColors.dark,
              callback: function(value) {
                  return currencyFormatter.format(value);
              }
          },
          grid: {
            color: 'rgba(0,0,0,0.05)'
          }
        },
        y1: {
          beginAtZero: true,
          position: 'right',
          grid: {
            drawOnChartArea: false,
            color: 'rgba(0,0,0,0.05)'
          },
          title: {
            display: true,
            text: 'Lucro (R$)',
            color: chartColors.dark
          },
          ticks: {
            color: chartColors.dark,
            callback: function(value) {
                return currencyFormatter.format(value);
            }
          }
        },
        x: {
            ticks: {
                color: chartColors.dark
            },
            grid: {
                color: 'rgba(0,0,0,0.05)'
            }
        }
      },
      plugins: {
        tooltip: {
          enabled: true,
          callbacks: {
              label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) {
                      label += ': ';
                  }
                  if (context.parsed.y !== null) {
                      label += currencyFormatter.format(context.parsed.y);
                  }
                  return label;
              }
          },
          backgroundColor: chartColors.dark,
          titleColor: '#fff',
          bodyColor: '#fff'
        },
        legend: {
          labels: {
            boxWidth: 20,
            color: chartColors.dark
          }
        }
      }
    }
  });
}

function desenharGraficoAgendamentosProfissional() {
    const ctx = document.getElementById('graficoAgendamentosProfissional').getContext('2d');

    const agendamentosPorProfissional = {};
    profissionais.forEach(p => agendamentosPorProfissional[p.nome] = 0);

    agendamentos.forEach(a => {
        if (a.status === "Concluído" && !a.naoPagou) { // Apenas agendamentos concluídos E pagos
            const profissional = profissionais.find(p => p.id === a.profId);
            if (profissional) {
                agendamentosPorProfissional[profissional.nome]++;
            }
        }
    });

    const labels = Object.keys(agendamentosPorProfissional);
    const data = Object.values(agendamentosPorProfissional);

    const backgroundColors = labels.map((_, i) => {
        const colors = [
            '#9c27b0', '#ba68c8', '#ce93d8', '#e1bee7', '#f3e5f5',
            '#673ab7', '#9575cd', '#b39ddb', '#d1c4e9', '#ede7f6'
        ];
        return colors[i % colors.length];
    });

    if(chartAgendamentosProfissional) chartAgendamentosProfissional.destroy();

    chartAgendamentosProfissional = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: backgroundColors,
                borderColor: '#fff',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'right',
                    labels: {
                        color: chartColors.dark,
                        boxWidth: 20
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed) {
                                label += context.parsed + ' agendamento(s)';
                            }
                            return label;
                        }
                    },
                    backgroundColor: chartColors.dark,
                    titleColor: '#fff',
                    bodyColor: '#fff'
                }
            }
        }
    });
}

function desenharGraficoServicosPopulares() {
    const ctx = document.getElementById('graficoServicosPopulares').getContext('2d');

    const servicosTotalizados = {};

    agendamentos.forEach(a => {
        if (a.status === "Concluído" && !a.naoPagou) { // Apenas serviços concluídos E pagos
            const profissional = profissionais.find(p => p.id === a.profId);
            const servico = profissional?.servicos[a.servIndex];
            if (servico) {
                if (servicosTotalizados[servico.nome]) {
                    servicosTotalizados[servico.nome] += servico.valor;
                } else {
                    servicosTotalizados[servico.nome] = servico.valor;
                }
            }
        }
    });

    const sortedServicos = Object.entries(servicosTotalizados)
        .sort(([, valueA], [, valueB]) => valueB - valueA)
        .slice(0, 5);

    const labels = sortedServicos.map(item => item[0]);
    const data = sortedServicos.map(item => item[1]);

    const backgroundColors = labels.map((_, i) => {
        const colors = [
            chartColors.primary,
            chartColors.secondary,
            chartColors.info,
            chartColors.success,
            chartColors.warning
        ];
        return colors[i % colors.length];
    });

    if(chartServicosPopulares) chartServicosPopulares.destroy();

    chartServicosPopulares = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Valor Total',
                data: data,
                backgroundColor: backgroundColors,
                borderColor: backgroundColors.map(color => color.replace('0.7', '1')),
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            scales: {
                x: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Valor (R$)',
                        color: chartColors.dark
                    },
                    ticks: {
                        color: chartColors.dark,
                        callback: function(value) {
                            return currencyFormatter.format(value);
                        }
                    },
                    grid: {
                        color: 'rgba(0,0,0,0.05)'
                    }
                },
                y: {
                    ticks: {
                        color: chartColors.dark
                    },
                    grid: {
                        color: 'rgba(0,0,0,0.05)'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.x !== null) {
                                label += currencyFormatter.format(context.parsed.x);
                            }
                            return label;
                        }
                    },
                    backgroundColor: chartColors.dark,
                    titleColor: '#fff',
                    bodyColor: '#fff'
                }
            }
        }
    });
}

function desenharGraficoNovosClientes() {
    const ctx = document.getElementById('graficoNovosClientes').getContext('2d');

    const clientesPorMes = {};
    clientes.forEach(c => {
        if (c.dataCadastro) {
            const mesAno = c.dataCadastro.slice(0, 7);
            clientesPorMes[mesAno] = (clientesPorMes[mesAno] || 0) + 1;
        }
    });

    const meses = Object.keys(clientesPorMes).sort();
    const dados = meses.map(mes => clientesPorMes[mes]);

    if (chartNovosClientes) chartNovosClientes.destroy();

    chartNovosClientes = new Chart(ctx, {
        type: 'line',
        data: {
            labels: meses,
            datasets: [{
                label: 'Novos Clientes',
                data: dados,
                borderColor: chartColors.info,
                backgroundColor: 'rgba(3, 169, 244, 0.2)',
                borderWidth: 2,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: chartColors.info,
                pointBorderColor: '#fff',
                pointRadius: 5,
                pointHoverRadius: 7
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    title: {
                        display: true,
                        text: 'Mês/Ano',
                        color: chartColors.dark
                    },
                    ticks: {
                        color: chartColors.dark
                    },
                    grid: {
                        color: 'rgba(0,0,0,0.05)'
                    }
                },
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: 'Número de Clientes',
                        color: chartColors.dark
                    },
                    ticks: {
                        color: chartColors.dark,
                        precision: 0
                    },
                    grid: {
                        color: 'rgba(0,0,0,0.05)'
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: chartColors.dark,
                    titleColor: '#fff',
                    bodyColor: '#fff'
                }
            }
        }
    });
}

function listarAgendamentosProximos() {
    const listaDiv = document.getElementById('listaAgendamentosProximos');
    listaDiv.innerHTML = '';

    const hoje = new Date();
    hoje.setHours(0, 0, 0, 0);

    const agendamentosFiltrados = agendamentos.filter(a => {
        const agendamentoData = new Date(a.data + 'T' + a.hora);
        agendamentoData.setSeconds(0, 0);
        
        if (agendamentoData < hoje) return false;
        
        const diffTime = Math.abs(agendamentoData - hoje);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        return diffDays <= 7 && a.status === "Pendente";
    }).sort((a, b) => {
        const dateTimeA = new Date(`${a.data}T${a.hora}`);
        const dateTimeB = new Date(`${b.data}T${b.hora}`);
        return dateTimeA - dateTimeB;
    });

    if (agendamentosFiltrados.length === 0) {
        listaDiv.innerHTML = '<li>Nenhum agendamento pendente nos próximos 7 dias.</li>';
        return;
    }

    agendamentosFiltrados.forEach(a => {
        const clienteNome = clientes.find(c => c.id === a.clienteId)?.nome || "Cliente Removido";
        const profissionalNome = profissionais.find(p => p.id === a.profId)?.nome || "Prof. Removido";
        const servicoNome = profissionais.find(p => p.id === a.profId)?.servicos[a.servIndex]?.nome || "Serviço Removido";

        listaDiv.innerHTML += `
            <li>
                <strong>${clienteNome}</strong> com ${profissionalNome} <br>
                <span>${servicoNome} em ${a.data} às ${a.hora}</span>
            </li>
        `;
    });
}


// ======= BACKUP E RESTAURAÇÃO =======
function exportarDados() {
  const dados = {
    clientes,
    profissionais,
    produtos,
    agendamentos,
    gastos,
    caixaInicial
  };
  try {
      const json = JSON.stringify(dados, null, 2);
      const blob = new Blob([json], {type: "application/json"});
      const url = URL.createObjectURL(blob);

      const a = document.createElement("a");
      a.href = url;
      a.download = "backup_espaco_tai_botelho.json";
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showToast("Dados exportados com sucesso!");
  } catch (error) {
      showToast("Erro ao exportar dados: " + error.message);
      console.error("Erro ao exportar dados:", error);
  }
}

function triggerImport() {
    showConfirmationModal(
        "Confirmação de Importação",
        "Importar dados substituirá *todos* os dados atuais. Tem certeza que deseja continuar?"
    ).then((result) => {
        if (result) {
            document.getElementById('inputImport').click();
        } else {
            showToast("Importação cancelada.");
        }
    });
}

function confirmImport(event) {
    const file = event.target.files[0];
    if (!file) {
        event.target.value = "";
        return;
    }

    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const dados = JSON.parse(e.target.result);
            clientes = dados.clientes || [];
            profissionais = dados.profissionais || [];
            produtos = dados.produtos || [];
            agendamentos = dados.agendamentos || [];
            gastos = dados.gastos || [];
            caixaInicial = dados.caixaInicial || 0;

            localStorage.setItem("clientes", JSON.stringify(clientes));
            localStorage.setItem("profissionais", JSON.stringify(profissionais));
            localStorage.setItem("produtos", JSON.stringify(produtos));
            localStorage.setItem("agendamentos", JSON.stringify(agendamentos));
            localStorage.setItem("gastos", JSON.stringify(gastos));
            localStorage.setItem("caixaInicial", caixaInicial);

            showToast("Dados importados com sucesso!");
            abrirSecao("dashboardSection");
        } catch (error) {
            showToast("Arquivo de backup inválido! Verifique o formato.");
            console.error("Erro ao importar dados:", error);
        } finally {
            event.target.value = "";
        }
    };
    reader.readAsText(file);
}

// Função genérica para confirmar exclusão com modal
async function confirmarExclusao(tipo, id, nomeItem) {
    const confirmMessage = `Tem certeza que deseja excluir este ${tipo} (${nomeItem})? Esta ação não pode ser desfeita e pode afetar registros relacionados (agendamentos).`;
    const result = await showConfirmationModal("Confirmar Exclusão", confirmMessage);
    if (result) {
        if (tipo === 'cliente') {
            excluirCliente(id);
        } else if (tipo === 'profissional') {
            excluirProfissional(id);
        } else if (tipo === 'produto') {
            excluirProduto(id);
        } else if (tipo === 'agendamento') {
            excluirAgendamento(id);
        }
    } else {
        showToast("Exclusão cancelada.");
    }
}


// Service Worker (incorporado para teste, mas recomendado em arquivo separado)
const serviceWorkerCode = `
const CACHE_NAME = 'espaco-tai-botelho-cache-v1';
const urlsToCache = [
  './',
  './index.html',
  'https://cdn.jsdelivr.net/npm/chart.js',
];

self.addEventListener('install', event => {
  event.waitUntil(
    caches.open(CACHE_NAME)
      .then(cache => {
        console.log('Opened cache');
        return cache.addAll(urlsToCache);
      })
  );
});

self.addEventListener('fetch', event => {
  event.respondWith(
    caches.match(event.request)
      .then(response => {
        if (response) {
          return response;
        }
        return fetch(event.request);
      })
  );
});

self.addEventListener('activate', event => {
  const cacheWhitelist = [CACHE_NAME];
  event.waitUntil(
    caches.keys().then(cacheNames => {
      return Promise.all(
        cacheNames.map(cacheName => {
          if (cacheWhitelist.indexOf(cacheName) === -1) {
            return caches.delete(cacheName);
          }
        })
      );
    })
  );
});
`;

// Registro do Service Worker
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    const serviceWorkerBlob = new Blob([serviceWorkerCode], { type: 'application/javascript' });
    const serviceWorkerUrl = URL.createObjectURL(serviceWorkerBlob);

    navigator.serviceWorker.register(serviceWorkerUrl)
      .then(registration => {
        console.log('Service Worker registered (from Blob): ', registration);
      })
      .catch(error => {
        console.log('Service Worker registration failed (from Blob): ', error);
      });
  });
}


// Inicializar dashboard ao carregar
window.onload = () => {
  document.getElementById("main").style.display = "none";
  document.getElementById("splash").style.display = "flex";
  atualizarDashboard(); // Garante que os números do dashboard são carregados
};
</script>

</body>
</html>
